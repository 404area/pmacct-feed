name: Build pmacct ipk for ImmortalWrt 23.05.4 x86_64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download ImmortalWrt 23.05.4 SDK (x86_64)
        run: |
          wget https://downloads.immortalwrt.org/releases/23.05.4/targets/x86/64/immortalwrt-sdk-23.05.4-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz -O sdk.tar.xz
          tar xf sdk.tar.xz
          mv immortalwrt-sdk-* sdk

      - name: Prepare pmacct package in SDK
        run: |
          mkdir -p sdk/package/network/utils/pmacct
          cp -r openwrt-package/pmacct/* sdk/package/network/utils/pmacct/

      - name: Update feeds and install dependencies
        working-directory: ./sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install libpcap zlib libmnl libcap libpthread librt  # pmacct 的核心依赖

      - name: Generate default config non-interactively
        working-directory: ./sdk
        run: |
          make defconfig

      - name: Compile pmacct package
        working-directory: ./sdk
        run: |
          make package/pmacct/compile V=s -j$(nproc) || true
          # 如果有错误，打印最后 50 行日志方便 debug（hash 等）
          tail -n 50 staging_dir/host/logs/package/network/utils/pmacct/compile.txt || true

      - name: Upload ipk artifact
        uses: actions/upload-artifact@v4
        with:
          name: pmacct-ipk-x86_64
          path: sdk/bin/packages/*/base/pmacct*.ipk
          if-no-files-found: warn
